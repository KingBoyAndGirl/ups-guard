# 🚀 UPS Guard 生产部署测试清单

## 一、本地开发测试

### 1.1 后端单元测试
```bash
cd backend
uv run pytest tests/ -v
```

### 1.2 前端构建测试
```bash
cd frontend
npm run build
```

### 1.3 Mock 模式功能测试
- [ ] 启动后端 Mock 模式：`MOCK_MODE=true`
- [ ] 启动前端开发服务器
- [ ] 验证 Dashboard 页面正常显示
- [ ] 验证 WebSocket 实时数据推送
- [ ] 验证设置页面各项配置可保存

---

## 二、功能测试清单

### 2.1 Dashboard 仪表盘
- [ ] UPS 状态显示正常（在线/电池供电/低电量）
- [ ] 电池电量仪表盘显示正确
- [ ] 输入/输出电压、负载、温度等指标显示
- [ ] 实时数据曲线图正常更新
- [ ] 最近事件列表显示

### 2.2 历史记录页面
- [ ] 日期范围选择器正常工作
- [ ] 双击日期可确认选择
- [ ] 选择日期后自动查询图表
- [ ] 快捷时间按钮（5分钟/1小时/24小时/7天）
- [ ] 数据导出功能（CSV/Excel）

### 2.3 事件页面
- [ ] 事件列表分页显示
- [ ] 事件类型筛选
- [ ] 事件详情查看

### 2.4 设置页面
- [ ] 关机策略配置保存
- [ ] 通知渠道添加/编辑/删除/测试
- [ ] 关机前置任务添加/编辑/删除/测试
- [ ] 系统配置（测试模式切换）
- [ ] 数据管理（清空数据）
- [ ] 配置导入/导出

### 2.5 通知功能
- [ ] Server酱推送测试
- [ ] PushPlus 推送测试
- [ ] 钉钉机器人推送测试
- [ ] Telegram 推送测试
- [ ] 邮件 SMTP 推送测试
- [ ] Webhook 推送测试

### 2.6 关机前置任务
- [ ] SSH 关机任务测试
- [ ] Windows 远程关机测试
- [ ] 群晖 NAS 关机测试
- [ ] 威联通 NAS 关机测试
- [ ] HTTP API 调用测试
- [ ] 自定义脚本执行测试

---

## 三、集成测试（Docker 环境）

### 3.1 构建镜像
```bash
cd deploy/docker
docker-compose build
```

### 3.2 启动服务
```bash
# 复制配置
cp .env.example .env
# 编辑 .env 配置 UPS 驱动等

# 启动
docker-compose up -d
```

### 3.3 验证服务
```bash
# 检查容器状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 检查 NUT 连接（先列出发现的 UPS，再查询详情）
docker-compose exec nut-server upsc -l localhost
docker-compose exec nut-server upsc <发现的UPS名称>@localhost
```

### 3.4 Web 界面测试
- [ ] 访问 http://localhost 正常
- [ ] 登录/认证正常
- [ ] 所有功能正常

---

## 四、UPS 实机测试（重要！）

### 4.1 准备工作
- [ ] 确认 UPS 通过 USB 连接到服务器
- [ ] 确认 UPS 驱动配置正确
- [ ] 确认关机策略配置合理
- [ ] 确认通知渠道配置正确
- [ ] 确认纳管设备配置正确

### 4.2 模拟断电测试
⚠️ **警告：以下测试会触发真实关机流程，请确保：**
- 已保存所有重要工作
- 已配置合理的等待时间
- 可以快速恢复电源

**测试步骤：**
1. [ ] 拔掉 UPS 输入电源（模拟断电）
2. [ ] 观察系统是否检测到断电事件
3. [ ] 观察是否收到断电通知
4. [ ] 观察关机倒计时是否正确显示
5. [ ] 在倒计时结束前恢复电源
6. [ ] 观察系统是否取消关机
7. [ ] 观察是否收到恢复供电通知

### 4.3 完整关机测试（可选）
⚠️ **仅在非生产环境测试**
1. [ ] 设置较短的等待时间（如 1 分钟）
2. [ ] 拔掉 UPS 电源
3. [ ] 等待系统自动关机
4. [ ] 验证纳管设备是否按顺序关机
5. [ ] 恢复电源，验证 WOL 唤醒功能

---

## 五、安全检查

### 5.1 认证配置
- [ ] API_TOKEN 已设置且足够复杂
- [ ] ENCRYPTION_KEY 已设置
- [ ] 前端访问需要认证

### 5.2 网络安全
- [ ] 仅必要端口对外开放
- [ ] 敏感配置已加密存储
- [ ] CORS 配置正确

### 5.3 数据备份
- [ ] 配置文件已导出备份
- [ ] 数据库定期备份

---

## 六、生产部署

### 6.1 懒猫微服部署
```bash
cd deploy/lazycat
# 使用 lzc-cli 打包
lzc-cli package -m lzc-manifest.yml -o ups-guard.lpk
# 上传到懒猫微服安装
```

### 6.2 群晖 NAS 部署
参考 `deploy/synology/README.md`

### 6.3 威联通 NAS 部署
参考 `deploy/qnap/README.md`

### 6.4 通用 Docker 部署
参考 `deploy/docker/README.md`

---

## 七、上线后监控

### 7.1 日志监控
```bash
# Docker 环境
docker-compose logs -f backend

# 检查错误
docker-compose logs backend | grep -i error
```

### 7.2 健康检查
- [ ] 定期检查 `/health` 端点
- [ ] 监控 UPS 连接状态
- [ ] 监控数据库大小

### 7.3 告警配置
- [ ] 配置断电告警通知
- [ ] 配置低电量告警通知
- [ ] 配置服务异常告警

---

## 八、回滚方案

### 8.1 配置回滚
1. 导入之前备份的配置文件
2. 重启服务

### 8.2 版本回滚
```bash
# Docker 环境
docker-compose down
# 切换到旧版本镜像
docker-compose up -d
```

---

## ✅ 上线确认

完成以上所有测试后，确认以下事项：

- [ ] 所有功能测试通过
- [ ] UPS 实机测试通过
- [ ] 安全配置已完成
- [ ] 监控告警已配置
- [ ] 备份方案已就绪
- [ ] 回滚方案已准备

**确认无误后，可以投入生产使用！** 🎉


# 深度测试的实际工作原理

## 问题

用户问："为什么深度测试只有根据时间停止，而不是降到低电量阈值（约 20%）才停止？"

---

## 核心答案

**深度测试实际上由UPS固件控制，会放电到低电量阈值（~20%）。监控程序的角色是采样记录数据和等待UPS完成，而不是判断何时停止。监控程序的"时间"只是超时保护机制（30分钟），不是停止条件。**

---

## 详细说明

### 1. 深度测试的两层架构

深度测试由两层协同工作：

#### 第一层：UPS固件（主导者）

```
UPS收到命令: test.battery.start.deep
    ↓
UPS固件开始控制:
    - 切换到电池供电
    - 持续放电
    - 监控电池电量
    - 当电量降到 battery.charge.low (~20%) 时停止
    - 切换回市电供电
    - 设置测试结果: ups.test.result = "Done and passed"
    - 清除测试状态: ups.status 不再包含 "CAL"
```

**关键**：UPS固件自己决定何时停止（降到20%）

#### 第二层：监控程序（观察者）

```
监控程序循环 (每15秒):
    ↓
采样当前状态:
    - battery.charge (电池电量)
    - battery.voltage (电池电压)
    - ups.status (UPS状态)
    - ups.test.result (测试结果)
    ↓
检查UPS是否还在测试:
    - 如果 ups.status 包含 "CAL" → 还在测试，继续采样
    - 如果 ups.status 不含 "CAL" → UPS已完成，停止监控
    ↓
记录数据到报告
```

**关键**：监控程序不判断何时停止，只是等待UPS完成

### 2. 为什么监控程序不检查电量？

#### 原因1：UPS固件已经控制

UPS固件在执行深度测试时，**已经内置了停止逻辑**：

```
UPS固件的逻辑:
if battery.charge <= battery.charge.low:
    stop_test()
    switch_to_ac_power()
    set_test_result("Done and passed")
```

这是UPS硬件/固件的功能，监控程序无法干预。

#### 原因2：避免冲突

如果监控程序也检查电量并发送停止命令：

```
问题场景:
1. 电量降到20%
2. 监控程序发送: test.battery.stop
3. 同时UPS固件也准备停止
4. 可能导致冲突或重复操作
```

**正确做法**：让UPS固件完全控制测试过程

#### 原因3：采样延迟

监控程序每15秒采样一次：

```
时间线:
00:00 - 电量 25%，监控采样
00:15 - 电量 22%，监控采样
00:30 - 电量 19%，监控采样 ← 已经低于20%了！

UPS固件实际上在 00:27 就停止了，
但监控程序要到 00:30 才知道。
```

如果监控程序检查电量，会有15秒的延迟误差。

### 3. 监控程序的实际停止条件

查看代码 `backend/src/api/ups_control.py` 第185-204行：

```python
# 检查是否正在测试（状态包含 CAL = 校准/测试）
is_testing = 'CAL' in ups_status or 'progress' in test_result.lower()

# 完成条件：
# 1. 已过最小等待时间 (60秒)
# 2. UPS 不在测试状态（没有 CAL 标志）
# 3. 测试结果不是 "in progress"
if elapsed >= min_wait and not is_testing:
    # UPS已完成测试
    await report_service.complete_test(result_status, test_result, ups_data)
    break
```

**停止条件**：UPS不再处于测试状态（`not is_testing`）

**不是**：电量降到20%

### 4. 30分钟超时的作用

```python
# 超时处理
if elapsed > timeout:  # timeout = 1800秒 = 30分钟
    logger.warning(f"[BatteryTest] Timeout after {elapsed:.1f}s")
    await report_service.complete_test(result_status, 'Timeout', ups_data)
    break
```

**超时是安全保护，不是正常停止条件**：

- **正常情况**：UPS在5-25分钟完成测试，监控程序检测到并停止
- **异常情况**：UPS没有完成（大容量空载），30分钟后强制停止监控

### 5. 完整的时间线示例

#### 正常场景（2000VA + 500W负载）

```
时间    电量    UPS状态    监控动作
--------------------------------------------
00:00   100%    OL CAL     开始监控，采样#1
00:15   95%     OL CAL     采样#2
00:30   90%     OL CAL     采样#3
...
15:00   50%     OL CAL     采样#60
...
20:00   30%     OL CAL     采样#80
22:00   25%     OL CAL     采样#88
24:00   21%     OL CAL     采样#96
                ↓
        UPS固件检测到21% ≈ battery.charge.low
        UPS停止测试，切换回市电
                ↓
24:30   20%     OL         采样#97 - 检测到CAL消失
                           停止监控 ✅
```

**实际停止原因**：UPS固件完成测试（到达20%）

**监控程序检测**：UPS状态不再包含CAL

#### 超时场景（3000VA空载）

```
时间    电量    UPS状态    监控动作
--------------------------------------------
00:00   100%    OL CAL     开始监控
05:00   98%     OL CAL     采样（放电很慢）
10:00   96%     OL CAL     采样
15:00   94%     OL CAL     采样
20:00   92%     OL CAL     采样
25:00   90%     OL CAL     采样
30:00   88%     OL CAL     超时！强制停止监控 ⚠️
```

**停止原因**：30分钟超时保护

**UPS状态**：实际上还在测试（需要60-90分钟才能到20%）

### 6. 为什么用户会误解？

#### 误解1：监控程序控制测试

**误解**：监控程序检查电量并决定何时停止

**事实**：UPS固件控制测试，监控程序只是观察者

#### 误解2：超时是主要停止条件

**误解**：30分钟到了就停止

**事实**：大多数情况下，UPS在30分钟前就完成了（5-25分钟）

#### 误解3：时间是固定的

**误解**：深度测试固定30分钟

**事实**：测试时间取决于UPS何时完成，30分钟只是上限

### 7. 快速测试 vs 深度测试

| 对比项 | 快速测试 | 深度测试 |
|--------|---------|---------|
| **执行者** | UPS固件 | UPS固件 |
| **停止条件** | 固定时间(10-30秒) | 电量降到~20% |
| **监控角色** | 等待固定时间 | 等待UPS完成 |
| **监控检查** | UPS状态（CAL消失） | UPS状态（CAL消失） |
| **超时保护** | 2分钟 | 30分钟 |
| **实际时长** | 10-30秒 | 5-90分钟（变化大） |

**共同点**：
- 都由UPS固件控制
- 监控程序都是检查UPS状态（不是电量）
- 都有超时保护

**区别**：
- 快速测试：UPS固定运行10-30秒
- 深度测试：UPS运行到电量降到20%

### 8. 技术实现对比

#### 监控程序的代码（实际）

```python
# backend/src/api/ups_control.py
def monitor_test_completion():
    while True:
        # 1. 采样数据
        battery_charge = get_battery_charge()
        ups_status = get_ups_status()
        
        # 2. 检查UPS是否还在测试
        is_testing = 'CAL' in ups_status
        
        # 3. 如果UPS完成，停止监控
        if not is_testing:
            complete_test()  # UPS已完成
            break
        
        # 4. 超时保护
        if elapsed > 1800:  # 30分钟
            complete_test('timeout')
            break
```

**注意**：代码中**没有** `if battery_charge <= 20: stop_test()`

#### 如果监控程序检查电量（假设）

```python
# 这段代码实际上不存在！
def monitor_test_completion():
    while True:
        battery_charge = get_battery_charge()
        
        # 假设：监控程序检查电量
        if battery_charge <= 20:
            execute_command('test.battery.stop')
            complete_test()
            break
```

**为什么没有这样实现？**
- UPS固件已经控制，不需要重复
- 避免冲突
- 避免采样延迟问题

### 9. UPS固件的 battery.charge.low 参数

UPS固件使用 `battery.charge.low` 参数控制深度测试：

```
查看参数:
$ upsc ups battery.charge.low
20

含义:
- 这是UPS固件的低电量阈值
- 深度测试会放电到这个值
- 默认通常是10-20%
- 可以通过驱动参数覆盖
```

在 `entrypoint.sh` 中覆盖：

```bash
# 覆盖低电量阈值为20%
-x battery.charge.low=20
```

**这个参数是给UPS固件用的，不是监控程序用的**

### 10. 常见问题

#### Q1: 为什么监控程序不检查电量？

**A**: 因为UPS固件已经控制了，监控程序只是记录数据和等待完成。

#### Q2: 那30分钟超时有什么用？

**A**: 安全保护，防止大容量UPS空载时测试过长（可能60-90分钟）。

#### Q3: 如果UPS固件有bug，一直不停止怎么办？

**A**: 30分钟超时会强制停止监控，防止无限等待。

#### Q4: 为什么不让监控程序在电量到20%时发送停止命令？

**A**: 
- UPS固件会自己停止，不需要
- 避免冲突
- 监控采样有延迟（15秒）

#### Q5: 能改成监控程序控制吗？

**A**: 不建议，因为：
- 破坏了UPS固件的完整性
- 可能导致测试不完整
- 采样延迟导致不准确

---

## 总结

### 用户的问题

**Q**: "为什么深度测试只有根据时间停止，而不是降到低电量阈值（约 20%）才停止？"

### 答案

**实际上深度测试是降到20%才停止，但是由UPS固件控制，不是监控程序控制**：

1. **UPS固件是主导者**
   - UPS收到深度测试命令后
   - 固件控制放电到 battery.charge.low (~20%)
   - 固件自己停止测试

2. **监控程序是观察者**
   - 每15秒采样数据
   - 检查UPS是否还在测试（CAL状态）
   - 等待UPS完成
   - 不检查电量，不发送停止命令

3. **30分钟是保护机制**
   - 不是正常停止条件
   - 是异常情况的超时保护
   - 防止大容量UPS空载时间过长

4. **实际停止原因**
   - **正常**：UPS固件完成测试（5-25分钟）
   - **异常**：超时保护触发（30分钟）

### 关键洞察

> **深度测试由UPS固件控制到20%，监控程序只是记录数据。所谓的"时间"只是超时保护，不是停止条件。**

### 架构图

```
用户点击"深度测试"
    ↓
监控程序发送命令: test.battery.start.deep
    ↓
UPS固件接管：
    ┌─────────────────────────────┐
    │  UPS固件控制测试            │
    │  - 切换到电池供电           │
    │  - 持续放电                 │
    │  - 监控电量                 │
    │  - 电量到20%时停止 ←─ 关键！│
    │  - 切换回市电               │
    │  - 清除CAL状态              │
    └─────────────────────────────┘
           ↑
           │ 监控程序循环：
           │ - 每15秒采样
           │ - 检查CAL状态
           │ - 记录数据
           │ - 等待完成
           │
    监控程序检测到CAL消失 → 停止监控 ✅
```

---

## 参考

- UPS测试命令：`test.battery.start.deep`
- UPS状态标志：`ups.status` (包含CAL表示测试中)
- 低电量阈值：`battery.charge.low` (默认10-20%)
- 代码实现：`backend/src/api/ups_control.py` 第132-220行

---

**总结一句话**：

> 深度测试由UPS固件控制放电到20%，监控程序通过检查UPS状态（CAL标志）来判断UPS是否完成，30分钟超时只是安全保护。


# 大容量电池深度测试指南

## 问题说明

**用户问题**："对于大容量电池，怎么深度测试降到低电量阈值（约 20%）"

对于大容量UPS（如2000VA及以上型号），电池容量大，深度测试从100%放电到20%可能需要**远超30分钟**的时间，可能导致测试超时无法完成真正的低电量测试。

---

## 当前系统限制

### 深度测试参数
- **超时时间**：30分钟（1800秒）
- **采样间隔**：15秒
- **目标**：电池放电到低电量阈值（~20%）

### 超时行为
如果30分钟后电池仍未降到20%：
- ✅ 测试自动完成
- ✅ 已采集的数据保存
- ⚠️ 结果标记为 'unknown' 或根据UPS返回的test.result判断
- ⚠️ 未能验证真正的低电量性能

---

## 为什么大容量电池需要更长时间？

### 放电时间计算

假设一个典型场景：

**小容量UPS**（650VA）：
- 电池容量：约7Ah（12V）
- 空载功耗：约8W
- 从100%到20%：约**6-8分钟**

**大容量UPS**（2000VA）：
- 电池容量：约24Ah（24V或2组12V）
- 空载功耗：约12-15W
- 从100%到20%：约**60-90分钟**！

**超大容量UPS**（3000VA+）：
- 电池容量：约40Ah或更高
- 外接电池组
- 从100%到20%：可能需要**2-3小时**！

### 影响因素
1. **电池容量** - 容量越大，放电时间越长
2. **负载大小** - 负载越小，放电越慢
3. **电池老化** - 新电池容量更大，放电时间更长
4. **环境温度** - 影响电池效率
5. **UPS效率** - 逆变器效率影响能量消耗

---

## 解决方案

### 方案1：增加测试负载（推荐）⭐

**原理**：通过增加负载，加快电池放电速度

**操作步骤**：
1. **准备负载设备**
   - 笔记本电脑（50-100W）
   - 台式机（200-300W）
   - 电暖器/电风扇（功率可调）
   - 其他安全电器

2. **确定安全负载**
   - 查看UPS额定功率（如2000VA = 约1200W）
   - 建议负载：额定功率的30-50%
   - 例如：2000VA UPS，使用400-600W负载

3. **执行测试**
   ```
   1. 连接负载设备到UPS
   2. 在Dashboard开始深度测试
   3. 监控电池放电速度
   4. 预计时间：15-30分钟
   ```

**负载建议**：
| UPS容量 | 建议负载 | 预计时间 |
|---------|---------|---------|
| 1000VA | 200-300W | 10-15分钟 |
| 2000VA | 400-600W | 15-25分钟 |
| 3000VA | 600-1000W | 20-30分钟 |

**注意事项**：
- ⚠️ 不要超过UPS额定功率
- ⚠️ 使用安全的电器设备
- ⚠️ 确保负载设备不会因突然断电受损
- ✅ 可使用多个小功率设备组合

---

### 方案2：分段测试

**原理**：不追求一次性测试到20%，分多次部分测试

**操作方法**：
1. **第一次测试**：从100%降到80%（约5-10分钟）
2. **第二次测试**：从80%降到60%（约5-10分钟）
3. **第三次测试**：从60%降到40%（约5-10分钟）
4. **第四次测试**：从40%降到20%（约5-10分钟）

**优点**：
- ✅ 每次测试时间短，不超时
- ✅ 可以观察不同电量段的放电曲线
- ✅ 更灵活的测试安排

**缺点**：
- ❌ 需要多次操作
- ❌ 每次测试间需要充电等待
- ❌ 总耗时更长

---

### 方案3：手动监控长时间测试

**原理**：接受30分钟超时，但继续手动监控直到20%

**操作步骤**：
1. 在Dashboard开始深度测试
2. 30分钟后测试自动完成
3. **不要停止**，继续监控Dashboard的电池电量
4. 手动记录数据：
   - 从测试开始到30分钟：系统自动记录
   - 30分钟后：手动记录电量百分比和时间
5. 当电量降到20%时，手动停止测试

**手动记录示例**：
```
开始时间：14:00
30分钟时（14:30）：电量65%
45分钟时（14:45）：电量45%
60分钟时（15:00）：电量25%
72分钟时（15:12）：电量20% ✓ 达到目标
```

**优点**：
- ✅ 无需修改系统
- ✅ 可以完整测试到20%

**缺点**：
- ❌ 需要人工监控
- ❌ 30分钟后的数据不在系统报告中
- ❌ 不方便

---

### 方案4：使用快速测试评估（替代方案）

**原理**：通过快速测试评估电池健康状况，不追求放电到20%

**操作方法**：
1. 使用**快速测试**（10-30秒）
2. 观察测试结果和电池电压
3. 多次快速测试，记录趋势
4. 根据电压降速率评估健康状况

**评估方法**：
- **良好**：快速测试中电压稳定，波动<0.5V
- **正常**：电压轻微下降，波动0.5-1V
- **老化**：电压明显下降，波动>1V
- **需更换**：电压快速下降，或测试失败

**优点**：
- ✅ 时间短（<1分钟）
- ✅ 对电池损耗小
- ✅ 可频繁进行

**缺点**：
- ❌ 不是真正的深度测试
- ❌ 无法准确评估低电量性能
- ❌ 适合日常检查，不适合全面评估

---

## 最佳实践建议

### 日常监控
1. **每月**进行一次快速测试
2. **每季度**进行一次深度测试（有负载）
3. **每半年**进行一次完整的低电量测试

### 深度测试准备
1. ✅ 选择业务空闲时间
2. ✅ 准备适当的测试负载
3. ✅ 确保市电稳定
4. ✅ 通知相关人员
5. ✅ 准备应急方案

### 大容量UPS特别建议

**对于2000VA及以上UPS**：

1. **使用负载测试**（方案1）
   - 最有效的方法
   - 接近实际使用场景
   - 时间可控

2. **考虑外部电池管理系统**
   - 如果UPS支持外部电池监控
   - 使用专业的电池分析仪
   - 更准确的容量测试

3. **定期记录趋势**
   - 记录每次测试的放电速率
   - 观察性能变化趋势
   - 及时发现电池老化

---

## 系统改进建议

### 对于未来版本

如果需要支持大容量电池的完整深度测试，可以考虑：

1. **增加超时时间选项**
   ```python
   # 当前
   timeout = 1800  # 30分钟
   
   # 改进
   timeout = get_config('deep_test_timeout', 1800)  # 可配置
   # 或根据电池容量自动调整
   if battery_capacity > 20Ah:
       timeout = 3600  # 60分钟
   elif battery_capacity > 40Ah:
       timeout = 7200  # 120分钟
   ```

2. **添加负载检测**
   - 检测当前负载大小
   - 估算放电时间
   - 动态调整超时

3. **提供测试进度预估**
   - 根据放电速率
   - 预估到达20%的时间
   - 提示用户是否需要增加负载

4. **支持暂停/恢复测试**
   - 可以暂停测试去充电
   - 之后继续测试
   - 累计测试数据

---

## FAQ

### Q1: 我的UPS是2000VA，深度测试30分钟后还有60%电量，怎么办？

**A1**: 这说明您的电池容量很大或负载很小。建议：
1. 增加测试负载到400-600W
2. 或使用方案3，继续手动监控直到20%
3. 或接受部分测试结果，主要观察放电趋势

### Q2: 增加负载会不会损坏UPS？

**A2**: 只要负载不超过UPS额定功率的70%就是安全的。例如：
- 2000VA UPS（约1200W），使用<840W负载
- 建议使用额定功率的30-50%作为测试负载

### Q3: 能否修改系统的30分钟超时限制？

**A3**: 当前版本的超时是硬编码的。如果需要修改，需要：
1. 修改 `backend/src/api/ups_control.py` 第142行
2. 将 `timeout = 1800` 改为更大的值（如 `3600` 或 `7200`）
3. 重启后端服务

**注意**：不建议设置过长的超时（>2小时），因为：
- 测试时间过长影响使用
- 电池长时间放电可能影响寿命
- 系统资源占用

### Q4: 我的UPS有外接电池组，怎么测试？

**A4**: 外接电池组通常容量更大（40Ah+），建议：
1. **必须使用负载**（方案1），否则可能需要3-4小时
2. 建议负载：UPS额定功率的50%
3. 或咨询UPS厂商的专业测试工具
4. 考虑分段测试（方案2）

### Q5: 测试时UPS会自动停止吗？

**A5**: 是的，当电池降到低电量阈值（约20%）时：
- UPS会自动结束测试
- 切回市电供电
- 开始充电
- 系统会记录测试完成

---

## 技术细节

### 代码位置

深度测试的超时和监控逻辑在：
```
backend/src/api/ups_control.py
函数：monitor_test_completion()
行号：132-220

第142行：timeout = 1800  # 深度测试最多 30 分钟
第143行：interval = 15   # 每 15 秒采样一次
```

### 测试完成条件

系统判断测试完成的依据：
1. UPS状态不再包含 'CAL'（校准/测试中）标志
2. `ups.test.result` 不是 "in progress"
3. 已超过最小等待时间（60秒）

或：
- 超过超时时间（30分钟）

### 低电量阈值

低电量阈值由UPS固件决定，通常是：
- `battery.charge.low` 参数值
- 默认约20%
- 不同厂商/型号可能不同（15-25%）

可以通过 NUT 命令查看：
```bash
upsc ups battery.charge.low
```

---

## 总结

**对于大容量电池深度测试**：

✅ **推荐方案**：
- **首选**：方案1 - 增加测试负载（最实用）
- **备选**：方案2 - 分段测试（最灵活）

❌ **不推荐**：
- 不增加负载的长时间测试（3小时+）
- 仅依赖快速测试评估大容量电池

⚠️ **关键提示**：
- 大容量UPS（2000VA+）**必须使用负载**进行深度测试
- 合理的负载可以将测试时间控制在15-30分钟内
- 安全第一，负载不要超过UPS额定功率的70%

---

## 相关文档

- [电池测试功能说明](./README.md) - 基础测试功能
- [用户手册](./user-guide.md) - 完整功能说明
- [FAQ](./faq.md) - 常见问题解答

---

**开发者**： (王.W)  
**版本**：v1.0.0  
**更新日期**：2026-02-15
